# Multi-environment example showing different VectorSidecar configurations
# for development, staging, and production environments

---
# Development Environment - verbose logging, console output
apiVersion: observability.kontroloop.ai/v1alpha1
kind: VectorSidecar
metadata:
  name: vector-dev
  namespace: development
spec:
  enabled: true
  selector:
    matchLabels:
      environment: dev
      observability: enabled
  sidecar:
    name: vector
    image: timberio/vector:0.35.0-alpine
    config:
      inline: |
        sources:
          kubernetes_logs:
            type: kubernetes_logs

        transforms:
          add_metadata:
            type: remap
            inputs:
              - kubernetes_logs
            source: |
              .environment = "development"
              .level = "debug"

        sinks:
          console:
            type: console
            inputs:
              - add_metadata
            encoding:
              codec: json
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 128Mi

---
# Staging Environment - moderate logging, send to staging backend
apiVersion: observability.kontroloop.ai/v1alpha1
kind: VectorSidecar
metadata:
  name: vector-staging
  namespace: staging
spec:
  enabled: true
  selector:
    matchLabels:
      environment: staging
      observability: enabled
  sidecar:
    name: vector
    image: timberio/vector:0.35.0
    config:
      configMapRef:
        name: vector-staging-config
        key: vector.yaml
    env:
      - name: VECTOR_LOG
        value: info
      - name: BACKEND_URL
        value: "http://logging-backend.staging.svc.cluster.local:9200"
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 256Mi
    volumeMounts:
      - name: logs
        mountPath: /var/log
  volumes:
    - name: logs
      emptyDir: {}

---
# Production Environment - minimal logging, high performance
apiVersion: observability.kontroloop.ai/v1alpha1
kind: VectorSidecar
metadata:
  name: vector-prod
  namespace: production
spec:
  enabled: true
  selector:
    matchLabels:
      environment: production
      observability: enabled
  sidecar:
    name: vector
    image: timberio/vector:0.35.0-alpine  # Smaller image for production
    config:
      configMapRef:
        name: vector-production-config
        key: vector.yaml
    env:
      - name: VECTOR_LOG
        value: warn
      - name: VECTOR_THREADS
        value: "2"
    resources:
      requests:
        cpu: 200m
        memory: 256Mi
      limits:
        cpu: 1000m
        memory: 512Mi
    volumeMounts:
      - name: varlog
        mountPath: /var/log
        readOnly: true
      - name: vector-data
        mountPath: /var/lib/vector
  volumes:
    - name: varlog
      hostPath:
        path: /var/log
    - name: vector-data
      emptyDir:
        sizeLimit: 1Gi

---
# Staging ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: vector-staging-config
  namespace: staging
data:
  vector.yaml: |
    sources:
      kubernetes_logs:
        type: kubernetes_logs

    transforms:
      enrich:
        type: remap
        inputs:
          - kubernetes_logs
        source: |
          .environment = "staging"
          .timestamp = now()

    sinks:
      http:
        type: http
        inputs:
          - enrich
        uri: "${BACKEND_URL:-http://localhost:9200}"
        encoding:
          codec: json
